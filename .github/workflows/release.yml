name: Deployment

on:
  release:
    types: [published]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
        - uses: actions/checkout@v2
        - name: Set up JDK 11
          uses: actions/setup-java@v1
          with:
              java-version: 11 
        # Grant execute permission to the gradlew script
        - name: Grant execute permission for gradlew
          run: chmod +x gradlew

        # Build the project with Gradle
        - name: Build with Gradle
          env:
            packageUser: ${{ secrets.BALLERINA_BOT_USERNAME }}
            packagePAT: ${{ secrets.BALLERINA_BOT_TOKEN }}
            JAVA_OPTS: -DBALLERINA_DEV_COMPILE_BALLERINA_ORG=true
          run: |
            ./gradlew build
        - name: Ballerina Build
          uses: ballerina-platform/ballerina-action@2201.3.1
          with:
            args:
              pack redis
          env:
            JAVA_HOME: /usr/lib/jvm/default-jvm 
            JAVA_OPTS: -DBALLERINA_DEV_COMPILE_BALLERINA_ORG=true
        - name: Ballerina Push
          uses: ballerina-platform/ballerina-action@2201.3.1
          with:
            args: 
              push
          env:
            JAVA_HOME: /usr/lib/jvm/default-jvm
            WORKING_DIR: ./redis
            BALLERINA_CENTRAL_ACCESS_TOKEN: ${{ secrets.BALLERINA_CENTRAL_ACCESS_TOKEN }}
